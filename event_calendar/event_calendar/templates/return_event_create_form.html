<!DOCTYPE html>
{% extends "common_template.html" %}
{% block script %}
<script>
        $(document).ready(function() {

            $('#return_date').datepicker({format: 'yyyy-mm-dd', weekStart: 1});

            function serialize_product(product_div) {
                return {
                    'product': $(product_div).find(".product_name").text(),
                    'amount': $(product_div).find(".product_amount").text()
                };
            }

            function serialize_products(products_div) {
                var result = [];
                $(products_div).find(".product_div").each(function() {
                    result.push(serialize_product($(this)));
                });
                return result;
            }

            function serialize_transport(transport_div) {
                return {
                    'from': $(transport_div).find("input[name=from]").val(),
                    'to': $(transport_div).find("input[name=to]").val(),
                    'products': serialize_products($(transport_div).find('.products_div'))
                }
            }

            function serialize_transports(transports_div) {
                var result = [];
                $(transports_div).find(".transport_div").each(function() {
                    transport = serialize_transport($(this))
                    result.push(transport);
                });
                return result;
            }

            $("#add_transport_button_1, #add_transport_button_2").click(function() {
                $transport_div = $("<div/>").addClass("transport_div").addClass("panel");
                $from_row = $("<div/>").addClass("row");
                $from_div = $("<div/>").addClass("col-md-7").append("from: <input type='text' name='from'/>");
                $remove_div = $("<div/>").addClass("col-md-2 col-md-offset-3").append("<button class='btn btn-default rm_transport_button'>remove</button>");

                $to_row = $("<div/>").addClass("row");
                $to_div = $("<div/>").addClass("col-md-7").append("to: <input type='text' name='to'/>");

                $products_div = $("<div/>").addClass("panel").addClass("products_div").addClass("col-md-10").css("border", "0px");

                $product_inputs_row = $("<div/>").addClass("row");
                $product_inputs = $("<div/>").addClass("col-md-10").append("product: <input type='text' name='product'/> amount: <input type='text' name='amount' size=14/>");

                $product_button = $("<div/>").addClass("col-md-2").append(" <button class='btn btn-primary btn-md' name='add_product_button'>add</button>");


                $transport_div.append($from_row.append($from_div).append($remove_div));
                $transport_div.append($to_row.append($to_div));
                $transport_div.append($products_div);
                $transport_div.append($product_inputs_row.append($product_inputs).append($product_button));

                $("#transports_div").append($transport_div);
            });


            $("body").on("click", "button[name=add_product_button]", function() {
                $product_div = $("<div/>").addClass("panel-body").addClass("product_div").addClass("row");
                $product_name = $("<div/>").addClass("product_name").addClass("col-md-7").text($(this).parent().parent().parent().find("input[name=product]").val());
                $product_amount = $("<div/>").addClass("product_amount").addClass("col-md-3").text($(this).parent().parent().parent().find("input[name=amount]").val());
                $remove_button = $("<button/>").addClass("btn").addClass("btn-default").addClass("btn-md").addClass("rm_product_button").text("remove");
                $product_div.append($product_name);
                $product_div.append($product_amount);
                $product_div.append($remove_button);

                $(this).parent().parent().parent().find(".products_div").append($product_div).css("border", "inherit");
            });

            $('#create_button').click(function() {
                var result = {
                    'event_id': $('#event_id').val(),
                    'vehicle_id': $('#vehicle_id').val(),
                    'return_date': $('#return_date').find('input').val(),
                    'comment': $('#comment').val(),
                    'transports': serialize_transports($('#transports_div'))
                }

                $.post(
                    '/events/create_return/',
                    JSON.stringify(result)
                ).done(function(data) {
                    alert(data);
                }).fail(function(data) {
                    $('#errors_div').html(data).show();
                })
            });

            $("body").on('click', '.rm_product_button', function() {
                if($(this).parent().parent().find(".product_div").length == 1) {
                    $(this).parent().parent().css("border", "0px");
                }
                $(this).parent().remove();
            });
            $("body").on('click', '.rm_transport_button', function() {
                $(this).parent().parent().parent().remove();
            });
        });
    </script>
{% endblock %}
{% block styles %}
    <link rel="stylesheet" type="text/css" href="/static/datepicker.css" />
{% endblock %}
{% block jumbo-content %}

    <div class="row">
        <div class="col-md-5" style="display: none;" id="errors_div"></div>
    </div>
    <div class="row">
            <input type="hidden" id="event_id" value="{{ event.id }}"/>
        {% if event.vehicle %}
            <div class="col-md-4">vehicle: {{ event.vehicle.registration }} <span style="background-color: #{{ event.vehicle.colour }}; width: 30px;">&nbsp</span></div>
            <input type="hidden" id="vehicle_id" value="{{ event.vehicle.id }}"/>
        {% else %}
            <div class="col-md-4">vehicle: no vehicle</div>
            <input type="hidden" id="vehicle_id" value=""/>
        {% endif %}
    </div>
    <div class="row">
        <div class="col-md-4">return date: <div id="return_date" class="input-append date" data-date="{{ date }}">
                        <input class="span2" size="16" type="text" value="{{ date }}">
                        <span class="add-on"><i class="icon icon_calendar"></i></span>
                      </div></div>
    </div>
    <div class="row">
        <div class="col-md-4">comment: <textarea cols="50" rows="5" id="comment"></textarea></div>
    </div>
    <div class="row">
        <div class="col-md-2 col-md-offset-8"><button class="btn btn-primary btn-lg" id="add_transport_button_1">add transport</button></div>
    </div>

    <div class="row">
        <div class="col-md-9">
            <div id="transports_div">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2 col-md-offset-8"><button class="btn btn-primary btn-lg" id="add_transport_button_2">add transport</button></div>
    </div>
    <div class="row">
        <div class="col-md-2 col-md-offset-8"><button class="btn btn-primary btn-lg" id="create_button">create</button></div>
    </div>

{% endblock %}