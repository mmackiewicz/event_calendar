<!DOCTYPE html>
{% extends "base_template.html" %}

{% block content %}
    <link rel="stylesheet" type="text/css" href="/static/calendar_large.css" />
    <script>
        $(document).ready(function(){

            function make_calendar() {
                $('#dp').datepicker({format: 'dd-mm-yyyy', weekStart: 1});
                var picker = $('#dp').data('datepicker').picker;
                var month = $('#dp').data('datepicker').viewDate.getMonth()+1;
                month = month < 10 ? '0'+month : ''+month;
                var year = ''+$('#dp').data('datepicker').viewDate.getUTCFullYear();

                $('#calendar_div #calendar_table').html(picker.find('.datepicker-days .table-condensed').html());

                // - put day numbers in divs
                // - append div to contain events in it
                $.each(
                    $('#calendar_table tbody tr td'),
                    function() {
                        $(this).html('<div class="day_number">'+$(this).html()+'</div><div class="events_container"></div>');
                    });

                // set 'id' for days of currently viewed month
                $.each(
                    $('#calendar_table tbody tr td.day').not('.old, .new'),
                    function() {
                        var day_number = $(this).find('.day_number').text();
                        day_number = day_number < 10 ? '0'+day_number : ''+day_number;
                        $(this).attr('id', year+'-'+month+'-'+day_number);
                    });

                // add a column for week number in front of every row
                $.each($('#calendar_table thead tr'), function() { $(this).html('<th></th>'+$(this).html());});
                $.each($('#calendar_table tbody tr'), function() { $(this).html('<td class="week_number"></td>'+$(this).html());});

                // put week numbers
                $.each($('#calendar_table tbody tr'), function() {
                    week_field = $(this).find('td').first();
                    date_str = $(this).find('.day').not('.old, .new').first().attr('id');
                    week_number = getWeekNumber(date_str)[1];
                    if(!isNaN(week_number)) {
                        week_field.text(week_number);
                    }
                });

                // create rows for displaying events for day
                $.each($('#calendar_table tbody tr'), function() {
                    $(this).after('<tr class="events_row" id="row'+$(this).find('td.week_number').text()+'"><td></td><td class="events_details" colspan=7><div class="panel"><span class="pull-left date_span"></span><span class="pull-right icon icon_cross"></span><span class="pull-right icon icon_add"></span></div></td></tr>');
                });
            }

            function fetch_events() {
                var year = $('#dp').data('datepicker').date.getUTCFullYear();
                var month = $('#dp').data('datepicker').date.getUTCMonth()+1;
                jQuery.get(
                        '/events/'+year+'/'+month+'/',
                        function(data) {
                            events = data['events'];
                            $.each(events, function() {
                                //console.log($(this)['recipients_date']);
                                var container = $('#'+this.recipients_date+' div.events_container');
                                container.html(container.html() + '<div class="event_div" id='+this.id+'>'+this.recipient+'</div>');
                            });
                        },
                        'json'
                )
            }


            function fetch_vehicles() {
                jQuery.get(
                        '/vehicles/all_extended/',
                        function(data) {
                            console.log(data);
                            vehicles = data['vehicles'];
                            $.each(vehicles, function() {
                                //console.log($(this)['recipients_date']);
                                //container.html(container.html() + '<div class="event_cal_div" id='+this.id+'>'+this.recipient+'</div>');
                                $('#vehicles_list').append('<li id="'+this.id+'">'+this.registration+'<span class="badge" style="background-color: #'+this.colour+';">aaa</span></li>');
                            });
                        },
                        'json'
                )
            }

            /*
               Fetches events for given date.
               @param date in format YYYY-MM-DD
             */
            function fetch_daily_events(events_date) {
                row_id = 'row'+getWeekNumber(events_date)[1];
                if($('#'+row_id).is(':visible')) {
                    $('#'+row_id).hide(200);
                }
                $('#'+row_id).find('td:nth-child(2)').find('.panel-default').remove();
                jQuery.get(
                        '/events/json/'+events_date.replace(/-/g,'/')+'/',
                        function(data) {
                            events = data['events'];
                            $('#'+row_id).find('td:nth-child(2)').find('.date_span').text(events_date);
                            $.each(events, function() {
                                $div = $table = $row = $td_locations = $td_load = $td_buttons = $div_buttons = '';

                                $div = $('<div/>', {
                                    class: 'panel panel-default',
                                    id: 'event'+this.id
                                });
                                $table = $('<table/>');
                                $row = $('<tr/>');
                                //------------------------
                                $td_locations = $('<td/>', {
                                    text: this.producer+' - '+this.recipient
                                });
                                //------------------------
                                $td_load = $('<td/>');
                                $.each(this.loads, function() {
                                    $td_load.append(this.product.name+' - '+this.amount+'<br/>');
                                });
                                //------------------------
                                $td_buttons = $('<td/>');
                                $div_buttons = $('<div/>', {
                                    class: 'btn-group'
                                });
                                $td_buttons.append($div_buttons);
                                if(this.return_event == '') {
                                    $div_buttons.append('<button class="btn btn-default add_return_button">add return</button>');
                                }
                                event_date = new Date(events_date);
                                current_date = new Date();
                                if(event_date >= current_date) {
                                    $div_buttons.append('<button class="btn btn-success edit_button">edit</button><button class="btn btn-danger cancel_button">cancel</button>');
                                }
                                //------------------------
                                $table.append($row);
                                $row.append($td_locations);
                                $row.append($td_load);
                                $row.append($td_buttons);
                                $div.append($table);

                                $('#'+row_id).find('td.events_details').append($div);
                            });
                            $('#'+row_id).show(200);
                        },
                        'json'
                )
            }

            $('#calendar_table').on('click', '.next', function() {
                $('#dp').data('datepicker').picker.find('.next:first').click();
                make_calendar();
                fetch_events();
                fetch_vehicles();
            });

            $('#calendar_table').on('click', '.prev', function() {
                $('#dp').data('datepicker').picker.find('.prev:first').click();
                make_calendar();
                fetch_events();
                fetch_vehicles();
            });

            $('#calendar_div').on('click','.day .day_number', function(){
                fetch_daily_events($(this).parent().attr('id'));
            });

            $('#calendar_div').on('mouseover', '.day_number', function() {
                $(this).addClass('selected');
            });

            $('#calendar_div').on('mouseout', '.day_number', function() {
                $(this).removeClass('selected');
            });

            $('#calendar_table').on('click', 'span.icon_cross', function() {
                parent_elem = $(this).parent().parent().parent();
                parent_elem.hide(200);
            })

            $('#calendar_table').on('click', 'span.icon_add', function() {
                date_val = $(this).parent().find('.date_span').text();
                $("#date_field").val(date_val);
                $('#event_create_form').submit();
            })

            make_calendar();
            fetch_events();
            fetch_vehicles();

        });
    </script>
    <div class="row">
        <div class="col-md-12" id="calendar_div">
            <table id="calendar_table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
    <div style="display: none;" id="dp" data-date="{% now dd-m-YY %}"></div>
    <form action="/events/create/" method="GET" id="event_create_form">
        <input type="hidden" id="date_field" name="date"/>
    </form>
{% endblock %}