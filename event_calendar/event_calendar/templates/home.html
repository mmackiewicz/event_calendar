<!DOCTYPE html>
{% extends "base_template.html" %}

{% block content %}
    <link rel="stylesheet" type="text/css" href="/static/calendar_large.css" />
    <script>
        $(document).ready(function(){

            function make_calendar() {
                $('#dp1').datepicker({format: 'dd-mm-yyyy', weekStart: 1});
                var picker = $('#dp1').data('datepicker').picker;
                var month = $('#dp1').data('datepicker').date.getUTCMonth()+1;
                month = month < 10 ? '0'+month : ''+month;
                var year = ''+$('#dp1').data('datepicker').date.getUTCFullYear();

                $('#calendar_div #calendar_table').html(picker.find('.datepicker-days .table-condensed').html());

                // - put day numbers in divs
                // - append div to contain events in it
                $.each(
                    $('#calendar_table tbody tr td'),
                    function() {
                        $(this).html('<div class="day_number">'+$(this).html()+'</div><div class="events_container"></div>');
                    });

                // set 'id' for days of currently viewed month
                $.each(
                    $('#calendar_table tbody tr td.day').not('.old, .new'),
                    function() {
                        var day_number = $(this).find('.day_number').text();
                        day_number = day_number < 10 ? '0'+day_number : ''+day_number;
                        $(this).attr('id', year+'-'+month+'-'+day_number);
                    });

                // add a column for week number in front of every row
                $.each($('#calendar_table thead tr'), function() { $(this).html('<th></th>'+$(this).html());});
                $.each($('#calendar_table tbody tr'), function() { $(this).html('<td class="week_number"></td>'+$(this).html());});

                // create rows for displaying events for day
                $.each($('#calendar_table tbody tr'), function() { $(this).after('<tr class="events_row"><td></td><td colspan=7></td></tr>');});

                // put week numbers
                $.each($('#calendar_table tbody tr').not('.events_row'), function() {
                    week_field = $(this).find('td').first();
                    date_str = $(this).find('.day').not('.old, .new').first().attr('id');
                    week_number = getWeekNumber(date_str)[1];
                    if(!isNaN(week_number)) {
                        week_field.text(week_number);
                    }
                });
            }

            function fetch_events() {
                var year = $('#dp1').data('datepicker').date.getUTCFullYear();
                var month = $('#dp1').data('datepicker').date.getUTCMonth()+1;
                jQuery.get(
                        '/events/'+year+'/'+month+'/',
                        function(data) {
                            events = data['events'];
                            $.each(events, function() {
                                //console.log($(this)['recipients_date']);
                                var container = $('#'+this.recipients_date+' div.events_container');
                                container.html(container.html() + '<div class="event_cal_div" id='+this.id+'>'+this.recipient+'</div>');
                            });
                        },
                        'json'
                )
            }

            function fetch_vehicles() {
                jQuery.get(
                        '/vehicles/all_extended/',
                        function(data) {
                            console.log(data);
                            vehicles = data['vehicles'];
                            $.each(vehicles, function() {
                                //console.log($(this)['recipients_date']);
                                //container.html(container.html() + '<div class="event_cal_div" id='+this.id+'>'+this.recipient+'</div>');
                                $('#vehicles_list').append('<li id="'+this.id+'">'+this.registration+'<span style="background-color: #'+this.colour+'; width: 32px;"></span></li>');
                            });
                        },
                        'json'
                )
            }

            /*
            // prepare date and go to event creation with it
            $('#calendar_div .day').not('.old, .new').click(function(){
                var day_number = $(this).text();
                if(day_number.length==1) {
                    day_number = "0"+day_number;
                }
                var date_val = day_number+$('#dp1').attr('data-date').substring(2);
                $("#date_field").val(date_val);
                $('#event_create_form').submit();
            });
            */

            $('#calendar_div').on('click','.day .day_number', function(){
                var day_number = $(this).text();
                if(day_number.length==1) {
                    day_number = "0"+day_number;
                }
                var date_val = $(this).parent().attr('id').replace(/-/g, "/");
                window.location.href='/events/'+date_val;
            });

            $('#calendar_div').on('mouseover', '.day_number', function() {
                $(this).addClass('selected');
            });

            $('#calendar_div').on('mouseout', '.day_number', function() {
                $(this).removeClass('selected');
            });


            make_calendar();
            fetch_events();
            fetch_vehicles();

        });
    </script>
    <div class="row">
        <div class="span4" style="float: left; left: 5px; top: 50%; z-index:10; position: absolute;">
            <div class="btn-group">
              <a class="btn btn-link dropdown-toggle" data-toggle="dropdown" href="#">
                <!--
                <h3>Choose Child</h3>
                <img id="mainIcons" src="boyStudent.png" alt="boyStudent">
                -->
                <span class="right-caret right"></span>
              </a>

              <ul class="dropdown-menu rightMenu">
                <li>
                  opcja1
                  <!--
                  <div class="btn-group">
                    <a href="parent_homepage_2.html" style="text-align:center;" class="btn btn-link operationsButtons">
                      <h5>A</h5>
                      <img id="mainIcons" src="boyStudent.png" alt="boyStudent">
                    </a>
                    <a href="parent_homepage_2.html" style="text-align:center;" class="btn btn-link operationsButtons">
                      <h5>J</h5>
                      <img id="mainIcons" src="girlStudent.png" alt="girlStudent">
                    </a>
                  </div>
                  -->
                </li>
                <li>
                    opcja2
                </li>
                <li>
                    opcja3
                </li>
              </ul>
            </div>
        </div>
        <div class="col-md-12" id="calendar_div">
            <table id="calendar_table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
    <div style="display: none;" id="dp1" data-date="{% now dd-m-YY %}"></div>
    <form action="/events/create/" method="GET" id="event_create_form">
        <input type="hidden" id="date_field" name="date"/>
    </form>
{% endblock %}